
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pymap3d &#8212; PyMap3D 1.5.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pymap3d</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Copyright (c) 2014-2018 Michael Hirsch, Ph.D.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Input/output: default units are METERS and DEGREES.</span>
<span class="sd">boolean deg=True means degrees</span>

<span class="sd">For most functions you can input Numpy arrays of any shape, except as noted in the functions</span>

<span class="sd">see tests/Test.py for example uses.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="k">import</span> <span class="n">string_types</span><span class="p">,</span><span class="n">PY2</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">radians</span><span class="p">,</span> <span class="n">arctan2</span><span class="p">,</span> <span class="n">hypot</span><span class="p">,</span> <span class="n">degrees</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">astropy.time</span> <span class="k">import</span> <span class="n">Time</span>
    <span class="kn">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
    <span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">Angle</span><span class="p">,</span><span class="n">SkyCoord</span><span class="p">,</span> <span class="n">EarthLocation</span><span class="p">,</span> <span class="n">AltAz</span><span class="p">,</span> <span class="n">ICRS</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">Time</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1">#</span>
<span class="kn">from</span> <span class="nn">.vallado</span> <span class="k">import</span> <span class="n">vazel2radec</span><span class="p">,</span> <span class="n">vradec2azel</span>
<span class="kn">from</span> <span class="nn">.timeconv</span> <span class="k">import</span> <span class="n">str2dt</span>


<span class="k">class</span> <span class="nc">EarthEllipsoid</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;wgs84&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;wgs84&#39;</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;https://en.wikipedia.org/wiki/World_Geodetic_System#WGS84&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">6378137.</span>  <span class="c1"># semi-major axis [m]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">298.2572235630</span>  <span class="c1"># flattening</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># semi-minor axis</span>
        <span class="k">elif</span> <span class="n">model</span><span class="o">==</span><span class="s1">&#39;grs80&#39;</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;https://en.wikipedia.org/wiki/GRS_80&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">6378137.</span>  <span class="c1"># semi-major axis [m]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">298.257222100882711243</span>  <span class="c1"># flattening</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># semi-minor axis</span>


<span class="c1">#%% to AER (azimuth, elevation, range)</span>
<div class="viewcode-block" id="ecef2aer"><a class="viewcode-back" href="../index.html#pymap3d.ecef2aer">[docs]</a><span class="k">def</span> <span class="nf">ecef2aer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert ECEF of target to azimuth, elevation, range (meters) from observer at lat0,lon0,h0 (meters)</span>
<span class="sd">    output: azimuth (deg), elevation (deg), slant range (m) for Obs-&gt;Point</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xEast</span><span class="p">,</span> <span class="n">yNorth</span><span class="p">,</span> <span class="n">zUp</span> <span class="o">=</span> <span class="n">ecef2enu</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">enu2aer</span><span class="p">(</span><span class="n">xEast</span><span class="p">,</span> <span class="n">yNorth</span><span class="p">,</span> <span class="n">zUp</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span></div>


<div class="viewcode-block" id="eci2aer"><a class="viewcode-back" href="../index.html#pymap3d.eci2aer">[docs]</a><span class="k">def</span> <span class="nf">eci2aer</span><span class="p">(</span><span class="n">eci</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert ECI of target to azimuth, elevation, range (meters) from observer at lat0,lon0,h0 (meters)</span>
<span class="sd">    output: azimuth (deg), elevation (deg), slant range (m) for Obs-&gt;Point</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ecef</span> <span class="o">=</span> <span class="n">eci2ecef</span><span class="p">(</span><span class="n">eci</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ecef2aer</span><span class="p">(</span><span class="n">ecef</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ecef</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ecef</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">)</span></div>


<div class="viewcode-block" id="enu2aer"><a class="viewcode-back" href="../index.html#pymap3d.enu2aer">[docs]</a><span class="k">def</span> <span class="nf">enu2aer</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert ENU (meters) to azimuth, elevation, range (meters)</span>

<span class="sd">    input: east, north, up [m]</span>

<span class="sd">    output: azimuth (deg), elevation (deg), slant range (m) for Obs-&gt;Point</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">hypot</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">slantRange</span> <span class="o">=</span> <span class="n">hypot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
    <span class="n">elev</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
    <span class="n">az</span> <span class="o">=</span>  <span class="n">arctan2</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">arctan2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">deg</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">degrees</span><span class="p">(</span><span class="n">az</span><span class="p">),</span> <span class="n">degrees</span><span class="p">(</span><span class="n">elev</span><span class="p">),</span> <span class="n">slantRange</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">az</span><span class="p">,</span> <span class="n">elev</span><span class="p">,</span> <span class="n">slantRange</span>  <span class="c1"># radians</span></div>


<div class="viewcode-block" id="geodetic2aer"><a class="viewcode-back" href="../index.html#pymap3d.geodetic2aer">[docs]</a><span class="k">def</span> <span class="nf">geodetic2aer</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    gives az,el,range from observer looking to target geodetic coordinates.</span>

<span class="sd">    input: Point(s): lat, lon, h (altitude, meters)</span>
<span class="sd">           Observer: lat0, lon0, h0 (altitude, meters)</span>

<span class="sd">    output: azimuth (deg), elevation (deg), slant range (m) for Obs-&gt;Point</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">geodetic2enu</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">enu2aer</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span></div>


<div class="viewcode-block" id="ned2aer"><a class="viewcode-back" href="../index.html#pymap3d.ned2aer">[docs]</a><span class="k">def</span> <span class="nf">ned2aer</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert target NED to azimuth, elevation, range (meters)</span>

<span class="sd">    output: azimuth (deg), elevation (deg), slant range (m) for Obs-&gt;Point</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">enu2aer</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="n">d</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span></div>

<span class="c1">#%% to ECEF</span>
<div class="viewcode-block" id="aer2ecef"><a class="viewcode-back" href="../index.html#pymap3d.aer2ecef">[docs]</a><span class="k">def</span> <span class="nf">aer2ecef</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">srange</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">alt0</span><span class="p">,</span> <span class="n">ell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert target azimuth, elevation, range (meters) from observer at lat0,lon0,alt0 to ECEF coordinates.</span>

<span class="sd">     Input: az,el; lat0,lon0 [degrees]   srange, alt0 [meters]</span>

<span class="sd">     output: ECEF x,y,z  [meters]</span>

<span class="sd">    if you specify NaN for srange, return value z will be NaN</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Origin of the local system in geocentric coordinates.</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="n">geodetic2ecef</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">alt0</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
    <span class="c1"># Convert Local Spherical AER to ENU</span>
    <span class="n">e1</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">u1</span> <span class="o">=</span> <span class="n">aer2enu</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">srange</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
    <span class="c1"># Rotating ENU to ECEF</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="n">_enu2uvw</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
    <span class="c1"># Origin + offset from origin equals position in ECEF</span>
    <span class="k">return</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">dz</span></div>


<div class="viewcode-block" id="eci2ecef"><a class="viewcode-back" href="../index.html#pymap3d.eci2ecef">[docs]</a><span class="k">def</span> <span class="nf">eci2ecef</span><span class="p">(</span><span class="n">eci</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert ECI to ECEF coordinates</span>

<span class="sd">    inputs: t is either a datetime or float in radians</span>

<span class="sd">    output: ECEF x,y,z (meters)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;You need to install AstroPy&#39;</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">string_types</span><span class="p">):</span> <span class="c1">#don&#39;t just ram in in case it&#39;s float</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">str2dt</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="n">gst</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">sidereal_time</span><span class="p">(</span><span class="s1">&#39;apparent&#39;</span><span class="p">,</span> <span class="s1">&#39;greenwich&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">radian</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">float</span><span class="p">):</span>
        <span class="n">gst</span> <span class="o">=</span> <span class="n">t</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;eci2ecef: time must be datetime or radian float&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>  <span class="c1"># must be in radians!</span>

    <span class="n">eci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">eci</span><span class="p">)</span>
    <span class="n">N</span><span class="p">,</span> <span class="n">trip</span> <span class="o">=</span> <span class="n">eci</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">eci</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">trip</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;eci triplets must be shape (N,3)&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;ported from:</span>
<span class="sd">    https://github.com/dinkelk/astrodynamics/blob/master/rot3.m</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ecef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">eci</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="c1">#ecef[i, :] = _rottrip(gst[i]) @ eci[i, :]</span>
        <span class="n">ecef</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">_rottrip</span><span class="p">(</span><span class="n">gst</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">eci</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>

    <span class="k">return</span> <span class="n">ecef</span></div>


<div class="viewcode-block" id="enu2ecef"><a class="viewcode-back" href="../index.html#pymap3d.enu2ecef">[docs]</a><span class="k">def</span> <span class="nf">enu2ecef</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">alt0</span><span class="p">,</span> <span class="n">ell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert ENU to ECEF coordinates</span>

<span class="sd">    inputs:</span>
<span class="sd">        ENU e1, n1, u1 (meters)</span>
<span class="sd">        observer lat0, lon0, alt0 (degrees,degrees,meters)</span>

<span class="sd">    output: ECEF x,y,z (meters)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="n">geodetic2ecef</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">alt0</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="n">_enu2uvw</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">dy</span><span class="p">,</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">dz</span></div>


<div class="viewcode-block" id="geodetic2ecef"><a class="viewcode-back" href="../index.html#pymap3d.geodetic2ecef">[docs]</a><span class="k">def</span> <span class="nf">geodetic2ecef</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">ell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert geodetic latitude, longitude, altiude (meters) to ECEF</span>

<span class="sd">    output: ECEF x,y,z (meters)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ell</span> <span class="o">=</span> <span class="n">EarthEllipsoid</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">deg</span><span class="p">:</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="c1"># radius of curvature of the prime vertical section</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">get_radius_normal</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">ell</span><span class="p">)</span>
    <span class="c1"># Compute cartesian (geocentric) coordinates given  (curvilinear) geodetic</span>
    <span class="c1"># coordinates.</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="n">alt</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="n">alt</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span><span class="o">.</span><span class="n">b</span> <span class="o">/</span> <span class="n">ell</span><span class="o">.</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">alt</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span></div>


<div class="viewcode-block" id="ned2ecef"><a class="viewcode-back" href="../index.html#pymap3d.ned2ecef">[docs]</a><span class="k">def</span> <span class="nf">ned2ecef</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert NED to ECEF coordinates, from observer at lat0,lon0,h0 (meters)</span>

<span class="sd">    output: NED (meters)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">enu2ecef</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="n">d</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span></div>

<span class="c1">#%% to ECI</span>
<div class="viewcode-block" id="aer2eci"><a class="viewcode-back" href="../index.html#pymap3d.aer2eci">[docs]</a><span class="k">def</span> <span class="nf">aer2eci</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">srange</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert target azimuth, elevation, range to ECI&quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">aer2ecef</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">srange</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">deg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ecef2eci</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)),</span> <span class="n">t</span><span class="p">)</span></div>


<div class="viewcode-block" id="ecef2eci"><a class="viewcode-back" href="../index.html#pymap3d.ecef2eci">[docs]</a><span class="k">def</span> <span class="nf">ecef2eci</span><span class="p">(</span><span class="n">ecef</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    input t is either a datetime or float in radians</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;Please install AstroPy&#39;</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">string_types</span><span class="p">):</span> <span class="c1">#don&#39;t just ram in in case it&#39;s float</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">str2dt</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="n">gst</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">sidereal_time</span><span class="p">(</span><span class="s1">&#39;apparent&#39;</span><span class="p">,</span> <span class="s1">&#39;greenwich&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">radian</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">float</span><span class="p">):</span>
        <span class="n">gst</span> <span class="o">=</span> <span class="n">t</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;eci2ecef: time must be datetime or radian float&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>  <span class="c1"># must be in radians!</span>

    <span class="n">ecef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">ecef</span><span class="p">)</span>
    <span class="n">N</span><span class="p">,</span> <span class="n">trip</span> <span class="o">=</span> <span class="n">ecef</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">ecef</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">trip</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;ecef triplets must be shape (N,3)&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;ported from:</span>
<span class="sd">    https://github.com/dinkelk/astrodynamics/blob/master/rot3.m</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">ecef</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="c1">#eci[i, :] = _rottrip(gst[i]).T @ ecef[i, :] # this one is transposed</span>
        <span class="n">eci</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">_rottrip</span><span class="p">(</span><span class="n">gst</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ecef</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> <span class="c1"># this one is transposed</span>

    <span class="k">return</span> <span class="n">eci</span></div>
<span class="c1">#%% to ENU</span>
<div class="viewcode-block" id="aer2enu"><a class="viewcode-back" href="../index.html#pymap3d.aer2enu">[docs]</a><span class="k">def</span> <span class="nf">aer2enu</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">srange</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    input: azimuth, elevation [deg]    slant range [m]</span>
<span class="sd">    output: East, North, Up [m]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">deg</span><span class="p">:</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
        <span class="n">az</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">az</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">srange</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">az</span><span class="p">),</span> <span class="n">r</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">az</span><span class="p">),</span> <span class="n">srange</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">el</span><span class="p">)</span></div>


<div class="viewcode-block" id="ecef2enu"><a class="viewcode-back" href="../index.html#pymap3d.ecef2enu">[docs]</a><span class="k">def</span> <span class="nf">ecef2enu</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert target ECEF (meters) to ENU (meters) from observer at lat0,lon0,h0 (degrees,degrees,meters)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="n">geodetic2ecef</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_uvw2enu</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z</span> <span class="o">-</span> <span class="n">z0</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span></div>


<div class="viewcode-block" id="ecef2enuv"><a class="viewcode-back" href="../index.html#pymap3d.ecef2enuv">[docs]</a><span class="k">def</span> <span class="nf">ecef2enuv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    for VECTOR i.e. between two points</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">deg</span><span class="p">:</span>
        <span class="n">lat0</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span>
        <span class="n">lon0</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span>

    <span class="n">t</span>      <span class="o">=</span>  <span class="n">cos</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span>
    <span class="n">uEast</span>  <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span>
    <span class="n">wUp</span>    <span class="o">=</span>  <span class="n">cos</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span>
    <span class="n">vNorth</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span>

    <span class="k">return</span> <span class="n">uEast</span><span class="p">,</span> <span class="n">vNorth</span><span class="p">,</span> <span class="n">wUp</span></div>


<div class="viewcode-block" id="geodetic2enu"><a class="viewcode-back" href="../index.html#pymap3d.geodetic2enu">[docs]</a><span class="k">def</span> <span class="nf">geodetic2enu</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert target geodetic coordinates to ENU (meters) from observer at lat0,lon0,h0 (degrees,degrees,meters)&quot;&quot;&quot;</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">geodetic2ecef</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">geodetic2ecef</span><span class="p">(</span><span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span>
    <span class="n">dz</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">z2</span>

    <span class="k">return</span> <span class="n">_uvw2enu</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span></div>
<span class="c1">#%% to geodetic</span>
<div class="viewcode-block" id="aer2geodetic"><a class="viewcode-back" href="../index.html#pymap3d.aer2geodetic">[docs]</a><span class="k">def</span> <span class="nf">aer2geodetic</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">srange</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">alt0</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Input: az,el; lat0,lon0 [degrees]   srange, alt0 [meters]</span>

<span class="sd">    output: WGS84 lat,lon [degrees]  altitude above spheroid  [meters]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">aer2ecef</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">srange</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">alt0</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ecef2geodetic</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span></div>


<div class="viewcode-block" id="ecef2geodetic"><a class="viewcode-back" href="../index.html#pymap3d.ecef2geodetic">[docs]</a><span class="k">def</span> <span class="nf">ecef2geodetic</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert ECEF (meters) to geodetic coordintes</span>

<span class="sd">    Algorithm is based on</span>
<span class="sd">    http://www.astro.uni.torun.pl/~kb/Papers/geod/Geod-BG.htm</span>
<span class="sd">    This algorithm provides a converging solution to the latitude equation</span>
<span class="sd">    in terms of the parametric or reduced latitude form (v)</span>
<span class="sd">    This algorithm provides a uniform solution over all latitudes as it does</span>
<span class="sd">    not involve division by cos(phi) or sin(phi)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">ell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ell</span> <span class="o">=</span> <span class="n">EarthEllipsoid</span><span class="p">()</span>

    <span class="n">ea</span> <span class="o">=</span> <span class="n">ell</span><span class="o">.</span><span class="n">a</span>
    <span class="n">eb</span> <span class="o">=</span> <span class="n">ell</span><span class="o">.</span><span class="n">b</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">hypot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="c1"># Constant required for Latitude equation</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">eb</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span> <span class="n">ea</span> <span class="o">*</span> <span class="n">rad</span><span class="p">)</span>
<span class="c1"># Constant required for latitude equation</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">ea</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">eb</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">hypot</span><span class="p">(</span><span class="n">ea</span> <span class="o">*</span> <span class="n">rad</span><span class="p">,</span> <span class="n">eb</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>
<span class="c1"># Starter for the Newtons Iteration Method</span>
    <span class="n">vnew</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">ea</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span> <span class="n">eb</span> <span class="o">*</span> <span class="n">rad</span><span class="p">)</span>
<span class="c1"># Initializing the parametric latitude</span>
    <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">v</span> <span class="o">!=</span> <span class="n">vnew</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">vnew</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1">#%% Newtons Method for computing iterations</span>
        <span class="n">vnew</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">rho</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="p">))</span> <span class="o">/</span>
                    <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">rho</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="p">))))</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1">#%% Computing latitude from the root of the latitude equation</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">ea</span> <span class="o">*</span> <span class="n">tan</span><span class="p">(</span><span class="n">vnew</span><span class="p">),</span> <span class="n">eb</span><span class="p">)</span>
    <span class="c1"># by inspection</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="n">alt</span> <span class="o">=</span> <span class="p">((</span><span class="n">rad</span> <span class="o">-</span> <span class="n">ea</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">vnew</span><span class="p">))</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span> <span class="o">+</span> \
        <span class="p">((</span><span class="n">z</span> <span class="o">-</span> <span class="n">eb</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">vnew</span><span class="p">))</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">deg</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">degrees</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="n">degrees</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">alt</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">alt</span>  <span class="c1"># radians</span></div>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">this is from PySatel and gives same result to EIGHT decimal places</span>
<span class="sd">def cbrt(x):</span>
<span class="sd">    if x &gt;= 0:</span>
<span class="sd">        return pow(x, 1.0/3.0)</span>
<span class="sd">    else:</span>
<span class="sd">        return -pow(abs(x), 1.0/3.0)</span>

<span class="sd">def ecef2geodetic(x, y, z, ell=EarthEllipsoid(),deg=True):</span>
<span class="sd">    a = ell.a; b = ell.b</span>
<span class="sd">    esq = 6.69437999014*0.001</span>
<span class="sd">    e1sq = 6.73949674228*0.001</span>
<span class="sd">    r = hypot(x,y)</span>
<span class="sd">    Esq = a**2 - b**2</span>
<span class="sd">    F = 54 * b**2 * z**2</span>
<span class="sd">    G = r**2 + (1 - esq)* z**2 - esq*Esq</span>
<span class="sd">    C = (esq**2 *F* r**2)/(pow(G, 3))</span>
<span class="sd">    S = cbrt(1 + C + sqrt(C**2 + 2*C))</span>
<span class="sd">    P = F/(3* pow((S + 1/S + 1), 2)*G**2)</span>
<span class="sd">    Q = sqrt(1 + 2* esq**2 *P)</span>
<span class="sd">    r_0 =  -(P*esq*r)/(1 + Q) + sqrt(0.5* a**2 *(1 + 1.0/Q) - \</span>
<span class="sd">           P*(1 - esq)*z**2/(Q*(1 + Q)) - 0.5*P* r**2)</span>
<span class="sd">    U = sqrt(pow((r - esq*r_0), 2) + z**2)</span>
<span class="sd">    V = sqrt(pow((r - esq*r_0), 2) + (1 - esq)* z**2)</span>
<span class="sd">    Z_0 = b**2 *z/(a*V)</span>
<span class="sd">    alt = U*(1 - b**2/(a*V))</span>
<span class="sd">    lat = arctan((z + e1sq*Z_0)/r)</span>
<span class="sd">    lon = arctan2(y, x)</span>

<span class="sd">    if deg:</span>
<span class="sd">        return degrees(lat),degrees(lon),alt</span>
<span class="sd">    else:</span>
<span class="sd">        return lat, lon, alt #radians</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="eci2geodetic"><a class="viewcode-back" href="../index.html#pymap3d.eci2geodetic">[docs]</a><span class="k">def</span> <span class="nf">eci2geodetic</span><span class="p">(</span><span class="n">eci</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert ECI to geodetic coordinates</span>

<span class="sd">    inputs:</span>

<span class="sd">    eci/ecef: a Nx3 vector of x,y,z triplets in the eci or ecef system [meters]</span>
<span class="sd">    t : length N vector of datetime OR greenwich sidereal time angle [radians].</span>

<span class="sd">    Note: Conversion is idealized: doesn&#39;t consider nutations, perterbations,</span>
<span class="sd">    etc. like the IAU-76/FK5 or IAU-2000/2006 model-based conversions</span>
<span class="sd">    from ECI to ECEF</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot; a.k.a. eci2lla() &quot;&quot;&quot;</span>
    <span class="n">ecef</span> <span class="o">=</span> <span class="n">eci2ecef</span><span class="p">(</span><span class="n">eci</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ecef2geodetic</span><span class="p">(</span><span class="n">ecef</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ecef</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ecef</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span></div>


<div class="viewcode-block" id="enu2geodetic"><a class="viewcode-back" href="../index.html#pymap3d.enu2geodetic">[docs]</a><span class="k">def</span> <span class="nf">enu2geodetic</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span>  <span class="n">ell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert target ENU from observer at lat0,lon0,h0 to geodetic coordinates&quot;&quot;&quot;</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">enu2ecef</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ecef2geodetic</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span></div>


<div class="viewcode-block" id="ned2geodetic"><a class="viewcode-back" href="../index.html#pymap3d.ned2geodetic">[docs]</a><span class="k">def</span> <span class="nf">ned2geodetic</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert target NED from observer at lat0,lon0,h0 to geodetic coordinates&quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">enu2ecef</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="n">d</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span>  <span class="n">ell</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ecef2geodetic</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span></div>
<span class="c1"># %% to NED</span>

<div class="viewcode-block" id="aer2ned"><a class="viewcode-back" href="../index.html#pymap3d.aer2ned">[docs]</a><span class="k">def</span> <span class="nf">aer2ned</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">elev</span><span class="p">,</span> <span class="n">slantRange</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert target azimuth, elevation, range to NED coordinates (meters)&quot;&quot;&quot;</span>
    <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">aer2enu</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">elev</span><span class="p">,</span> <span class="n">slantRange</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="n">u</span></div>


<div class="viewcode-block" id="ecef2ned"><a class="viewcode-back" href="../index.html#pymap3d.ecef2ned">[docs]</a><span class="k">def</span> <span class="nf">ecef2ned</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert target ECEF (meters) to NED (meters) from observer at lat0,lon0,h0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">ecef2enu</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="n">u</span></div>


<div class="viewcode-block" id="ecef2nedv"><a class="viewcode-back" href="../index.html#pymap3d.ecef2nedv">[docs]</a><span class="k">def</span> <span class="nf">ecef2nedv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    for VECTOR between two points</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">ecef2enuv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="n">u</span></div>


<div class="viewcode-block" id="geodetic2ned"><a class="viewcode-back" href="../index.html#pymap3d.geodetic2ned">[docs]</a><span class="k">def</span> <span class="nf">geodetic2ned</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert target geodetic coordinates to NED (meters) from observer at lat0,lon0,h0&quot;&quot;&quot;</span>
    <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">geodetic2enu</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">ell</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="n">u</span></div>

<span class="c1">#%% shared functions</span>

<span class="k">def</span> <span class="nf">get_radius_normal</span><span class="p">(</span><span class="n">lat_radians</span><span class="p">,</span> <span class="n">ell</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ell</span> <span class="o">=</span> <span class="n">EarthEllipsoid</span><span class="p">()</span>


    <span class="n">a</span> <span class="o">=</span> <span class="n">ell</span><span class="o">.</span><span class="n">a</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">ell</span><span class="o">.</span><span class="n">b</span>

    <span class="k">return</span> <span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span>
        <span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_radians</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span>
        <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">lat_radians</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#%% internal use</span>
<span class="k">def</span> <span class="nf">_rottrip</span><span class="p">(</span><span class="n">ang</span><span class="p">):</span>
    <span class="n">ang</span> <span class="o">=</span> <span class="n">ang</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ang</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;only one angle allowed at a time&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;ported from:</span>
<span class="sd">    https://github.com/dinkelk/astrodynamics/blob/master/rot3.m</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">),</span>  <span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>        <span class="mi">1</span><span class="p">]])</span>


<span class="k">def</span> <span class="nf">_enu2uvw</span><span class="p">(</span><span class="n">east</span><span class="p">,</span> <span class="n">north</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">deg</span><span class="p">:</span>
        <span class="n">lat0</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span>
        <span class="n">lon0</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span> <span class="o">*</span> <span class="n">up</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span> <span class="o">*</span> <span class="n">north</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span> <span class="o">*</span> <span class="n">up</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span> <span class="o">*</span> <span class="n">north</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span> <span class="o">*</span> <span class="n">east</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span> <span class="o">*</span> <span class="n">east</span>

    <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span>


<span class="k">def</span> <span class="nf">_uvw2enu</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">lat0</span><span class="p">,</span> <span class="n">lon0</span><span class="p">,</span> <span class="n">deg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">deg</span><span class="p">:</span>
        <span class="n">lat0</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span>
        <span class="n">lon0</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span>
    <span class="n">East</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">lon0</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span>
    <span class="n">Up</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span>
    <span class="n">North</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat0</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span>

    <span class="k">return</span> <span class="n">East</span><span class="p">,</span> <span class="n">North</span><span class="p">,</span> <span class="n">Up</span>

<span class="c1"># %% azel radec</span>
<div class="viewcode-block" id="azel2radec"><a class="viewcode-back" href="../index.html#pymap3d.azel2radec">[docs]</a><span class="k">def</span> <span class="nf">azel2radec</span><span class="p">(</span><span class="n">az_deg</span><span class="p">,</span> <span class="n">el_deg</span><span class="p">,</span> <span class="n">lat_deg</span><span class="p">,</span> <span class="n">lon_deg</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert astronomical target horizontal azimuth, elevation to ecliptic right ascension, declination (degrees)&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">PY2</span> <span class="ow">or</span> <span class="n">Time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># non-AstroPy method, less accurate</span>
        <span class="k">return</span> <span class="n">vazel2radec</span><span class="p">(</span><span class="n">az_deg</span><span class="p">,</span> <span class="n">el_deg</span><span class="p">,</span> <span class="n">lat_deg</span><span class="p">,</span> <span class="n">lon_deg</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">str2dt</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">obs</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">lat_deg</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon_deg</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

    <span class="n">direc</span> <span class="o">=</span> <span class="n">AltAz</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
                  <span class="n">az</span><span class="o">=</span><span class="n">az_deg</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="n">el_deg</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

    <span class="n">sky</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">direc</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">ICRS</span><span class="p">()))</span>

    <span class="k">return</span> <span class="n">sky</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">sky</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span></div>


<div class="viewcode-block" id="radec2azel"><a class="viewcode-back" href="../index.html#pymap3d.radec2azel">[docs]</a><span class="k">def</span> <span class="nf">radec2azel</span><span class="p">(</span><span class="n">ra_deg</span><span class="p">,</span> <span class="n">dec_deg</span><span class="p">,</span> <span class="n">lat_deg</span><span class="p">,</span> <span class="n">lon_deg</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert astronomical target ecliptic right ascension, declination to horizontal azimuth, eelvation (degrees)&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vradec2azel</span><span class="p">(</span><span class="n">ra_deg</span><span class="p">,</span> <span class="n">dec_deg</span><span class="p">,</span> <span class="n">lat_deg</span><span class="p">,</span> <span class="n">lon_deg</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<span class="c1">#%% input trapping</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">str2dt</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">lat_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">lat_deg</span><span class="p">)</span>
    <span class="n">lon_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">lon_deg</span><span class="p">)</span>
    <span class="n">ra_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">ra_deg</span><span class="p">)</span>
    <span class="n">dec_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">dec_deg</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">lat_deg</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;</span> <span class="n">lon_deg</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;radec2azel is designed for one observer and one or more points (ra,dec).&#39;</span>
    <span class="k">assert</span> <span class="n">ra_deg</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">dec_deg</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;ra and dec must be the same shape ndarray&#39;</span>

    <span class="n">obs</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">lat_deg</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                        <span class="n">lon</span><span class="o">=</span><span class="n">lon_deg</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">Angle</span><span class="p">(</span><span class="n">ra_deg</span><span class="p">,</span>  <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                      <span class="n">Angle</span><span class="p">(</span><span class="n">dec_deg</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
                      <span class="n">equinox</span><span class="o">=</span><span class="s1">&#39;J2000.0&#39;</span><span class="p">)</span>

    <span class="n">altaz</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">AltAz</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">altaz</span><span class="o">.</span><span class="n">az</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">altaz</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">degree</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Michael Hirsch, Ph.D..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>